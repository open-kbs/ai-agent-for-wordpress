(()=>{var __webpack_modules__={763:module=>{module.exports=eval("require")("axios")}};var __webpack_module_cache__={};function __nccwpck_require__(e){var t=__webpack_module_cache__[e];if(t!==undefined){return t.exports}var a=__webpack_module_cache__[e]={exports:{}};var s=true;try{__webpack_modules__[e](a,a.exports,__nccwpck_require__);s=false}finally{if(s)delete __webpack_module_cache__[e]}return a.exports}(()=>{__nccwpck_require__.n=e=>{var t=e&&e.__esModule?()=>e["default"]:()=>e;__nccwpck_require__.d(t,{a:t});return t}})();(()=>{__nccwpck_require__.d=(e,t)=>{for(var a in t){if(__nccwpck_require__.o(t,a)&&!__nccwpck_require__.o(e,a)){Object.defineProperty(e,a,{enumerable:true,get:t[a]})}}}})();(()=>{__nccwpck_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{__nccwpck_require__.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var __webpack_exports__={};(()=>{"use strict";__nccwpck_require__.r(__webpack_exports__);__nccwpck_require__.d(__webpack_exports__,{handler:()=>handler});const e=require("vm");var t=__nccwpck_require__.n(e);var a=__nccwpck_require__(763);var s=__nccwpck_require__.n(a);const r=/(?:writeFile\s+([^\s]+)\s*```(\w+)\s*([\s\S]*?)```|``javascript\s*([\s\S]*?)\s*``|\/?(googleSearch|webpageToText|viewImage|metaAction|suggestion|jobCompleted|jobFailed)\(([^()]*)\))/g;function detectLazyOutput(e){return e.split("\n").some((e=>{const t=e.trim().substring(2).trim().toLowerCase();return e.trim().startsWith("//")&&["...","same"].some((e=>t.includes(e)))}))}const getActions=e=>[[r,async(a,o)=>{const c=o.payload.messages[o.payload.messages.length-1].content;let _=e?._meta_actions?.includes("REQUEST_CHAT_MODEL_EXCEEDED");let n=Array.from(c.matchAll(r)).map((([t,a,s,r,o,c,n])=>{if(a&&s&&r){return{type:"writeFile",path:a.trim(),language:s.trim(),content:r.trim()}}else if(o){return{type:"javascript",content:o.trim()}}else if(c){if(c==="suggestion"){e._meta_actions=e._meta_actions.filter((e=>e!=="REQUEST_CHAT_MODEL"));_=true}if(n?.startsWith('"')&&n?.endsWith('"')){n=n.slice(1,-1)}let t=n.trim();let a=false;try{t=JSON.parse(n);a=true}catch(e){}return{type:c,arg:t}}}));const i=n.findLast((e=>e?.type==="metaAction"&&e?.arg==="execute_and_callback"));n=[...n.filter((e=>!(e?.type==="metaAction"&&e?.arg==="execute_and_callback"))),...i?[i]:[]];if(n.length===0){return{error:"No valid blocks or commands found",...e}}try{const a=[];let r;for(const c of n){if(r)break;if(c.type==="writeFile"&&detectLazyOutput(c.content)){a.push({type:"writeFile",path:c.path,success:false,error:`Lazy comment detected in writeFile block, please provide complete source code for path: ${c.path}`});continue}const n="{{secrets.wpUrl}}";const i={"WP-API-KEY":"{{secrets.wpapiKey}}"};const handleJobFinished=async(e,t,a,r)=>{const{arg:c}=e;const{post_id:_,message:n}=c;const i=await openkbs.encrypt(n);const p=[openkbs.chats({action:"updateChat",title:i,chatIcon:e?.type==="jobCompleted"?"ðŸŸ¢":"ðŸ”´",chatId:o?.payload?.chatId})];if(_){p.push(s().post(`${t}/wp-json/openkbs/v1/callback`,{post_id:_,message:n,type:"reload"},{headers:a}))}await Promise.all(p);r.push({type:e.type,success:true,data:c})};switch(c.type){case"writeFile":{const e=`${n}/wp-json/openkbs/v1/filesystem`;const t=await s().post(`${e}/write`,{path:c.path,content:c.content},{headers:i});a.push({type:"writeFile",path:c.path,language:c.language,success:t.status===200});break}case"javascript":{let e=c.content.replace(`{{secrets.wpapiKey}}`,"{{secrets.wpapiKey}}").replace(`{{secrets.wpUrl}}`,"{{secrets.wpUrl}}");if(!e.includes("module.exports"))e+="\nmodule.exports = { handler };";const s=new(t().Script)(e);const r={require:e=>rootContext.require(e),...rootContext,console:console,module:{exports:{}}};t().createContext(r);s.runInContext(r);const{handler:o}=r.module.exports;const _=await o();a.push({type:"javascript",success:!_?.error,data:_});break}case"googleSearch":{const e="{{secrets.googlesearch_api_key}}".includes("secrets.googlesearch_api_key");const t={q:c.arg,...e?{}:{key:"{{secrets.googlesearch_api_key}}",cx:"{{secrets.googlesearch_engine_id}}"}};const r=e?await openkbs.googleSearch(t.q,t):(await s().get("https://www.googleapis.com/customsearch/v1",{params:t}))?.data?.items;const o=r?.map((({title:e,link:t,snippet:a,pagemap:s})=>({title:e,link:t,snippet:a,image:s?.metatags?.[0]?.["og:image"]})));a.push({type:"googleSearch",success:!!o?.length,data:o||{error:"No results found"}});break}case"webpageToText":{const e=await openkbs.webpageToText(c.arg);if(e?.content?.length>5e3){e.content=e.content.substring(0,5e3)}a.push({type:"webpageToText",success:!!e?.url,data:e?.url?e:{error:"Unable to read website"}});break}case"viewImage":{a.push({type:"viewImage",success:true,data:[{type:"text",text:"Image URL: "+c.arg},{type:"image_url",image_url:{url:c.arg}}]});break}case"metaAction":{r=true;if(c.arg==="execute_and_callback"){if(!_&&!e._meta_actions.includes("REQUEST_CHAT_MODEL")){e._meta_actions.push("REQUEST_CHAT_MODEL")}}else if(c.arg==="execute_and_wait"){e._meta_actions=e._meta_actions.filter((e=>e!=="REQUEST_CHAT_MODEL"))}a.push({type:"metaAction",success:true,data:c.arg});break}case"jobCompleted":case"jobFailed":r=true;await handleJobFinished(c,n,i,a);break}}const c=a.every((e=>e.success));if(c){return{data:{message:"All operations completed successfully",results:a},...e}}else{if(!_)e._meta_actions=["REQUEST_CHAT_MODEL"];return{data:{error:"Some operations failed",results:a},...e}}}catch(t){if(!_)e._meta_actions=["REQUEST_CHAT_MODEL"];return{error:t.response?.data||t.message,...e}}}]];const handler=async e=>{const t=50;const a=getActions({_meta_actions:e?.payload?.messages?.length>t?["REQUEST_CHAT_MODEL_EXCEEDED"]:["REQUEST_CHAT_MODEL"]});for(let[t,s]of a){const a=e.payload.messages[e.payload.messages.length-1].content;const r=a?.match(t);if(r)return await s(r,e)}return{type:"CONTINUE"}}})();module.exports=__webpack_exports__})();